name: Build and Deploy Specific Version

on:
  workflow_call:
    inputs:
      deploy_confirmation:
        description: 'Outcome if user manually confirmed the start of the deploy script'
        type: string
        required: true
      target_version:
        description: 'The version of that needs to be deployed'
        required: true
        type: string
      version_file_path:
        description: The path to the php version file
        type: string
        required: false
        default: app/version.php
      target_repository:
        description: The target repository for the build
        type: string
        required: true
      target_repository_folder:
        description: The folder in which the target repository will be checked out
        type: string
        required: false
        default: target_repository_folder
      production_image_name:
        description: The name the production docker image. This is also the name of the ECR repository (optional)
        type: string
      staging_image_name:
        description: The name the staging docker image. This is also the name of the ECR repository (optional)
        type: string
      util_image_name:
        description: The name the util docker image. This is also the name of the ECR repository (optional)
        type: string
      dockerfile:
        description: Relative dockerfile to the docker file seen from the repository root. No leading slash.
        type: string
        required: true
      ecs_service:
        description: 'ECS service name'
        type: string
        required: true
      ecs_cluster:
        description: 'ECS cluster name'
        type: string
        required: true
      ecs_region:
        description: 'AWS region'
        type: string
        required: true
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
        description: AWS access key id
      AWS_SECRET_ACCESS_KEY:
        required: true
        description: AWS access key secret

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ensure-master-branch:
    name: Check current branch
    if: ${{ inputs.deploy_confirmation == 'DEPLOY' || inputs.deploy_confirmation == 'YOLO' }}
    outputs:
      status: ${{ steps.early.outputs.status }}
    runs-on: ubuntu-latest
    steps:
      - id: early
        name: Checking if current branch is master
        run: |
          if [ "${{ github.ref }}" != "refs/heads/master" ]; then
            echo "Error this can only run on master branch"
            exit 1
          fi
          echo "status=success" >> $GITHUB_OUTPUT

  determine-image-name:
    name: Determine image name based on environment
    needs: ensure-master-branch
    outputs:
      image_name: ${{ steps.image_name.outputs.image_name }}
    runs-on: ubuntu-latest
    steps:
      - id: image_name
        name: Check which image name to use based on enviroment
        run: |
          if [ "${{ inputs.ecs_cluster }}" == "RM4G" ]; then
            if [ -n "${{ inputs.production_image_name}}"]; then
              echo "image_name=${{inputs.production_image_name}}" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          elif [ "${{ inputs.ecs_cluster }}" == "Staging" ]; then
            if [ -n "${{ inputs.staging_image_name}}"]; then
              echo "image_name=${{inputs.staging_image_name}}" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          elif [ "${{ inputs.ecs_cluster }}" == "Util" ]; then
            if [ -n "${{ inputs.util_image_name}}"]; then
              echo "image_name=${{inputs.util_image_name}}" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "Invalid image name config for environment ${{inputs.ecs_cluster}}"
          exit 1

  docker-build:
    name: Build image
    uses: rentmanpublic/actions/.github/workflows/ecr-build-and-push.yml@master
    needs: determine-image-name
    if: needs.ensure-master-branch.outputs.status == 'success'
    with:
      image_name: ${{ needs.determine-image-name.outputs.image_name }}
      image_tag: latest ${{ inputs.target_version  }}
      dockerfile: ${{ inputs.dockerfile }}
      platforms: amd64
      push_images: 1
      ref: ${{ inputs.target_version }}
    secrets:
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}

  deploy:
      name: Deploy to ECS
      needs: docker-build
      uses: rentmanpublic/actions/.github/workflows/ecs-redeploy-service.yml@master
      with:
        service: ${{ inputs.ecs_service }}
        cluster: ${{ inputs.ecs_cluster }}
        region:  ${{ inputs.ecs_region }}
      secrets:
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}